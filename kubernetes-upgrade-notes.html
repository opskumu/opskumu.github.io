<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2019-09-22 Sun 19:59 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Kubernetes 版本升级标注</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Kumu" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="css/org.css"/>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2019 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">Kubernetes 版本升级标注</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org10309ec">1. 1.5.x &#x2013;&gt; 1.6.x</a>
<ul>
<li><a href="#org3121dd8">1.1. etcd 备份和数据迁移</a></li>
<li><a href="#orgdfa6822">1.2. Docker 版本支持</a></li>
</ul>
</li>
<li><a href="#org93c2249">2. 1.6.x &#x2013;&gt; 1.7.x</a></li>
<li><a href="#org3ad6037">3. 1.7.x &#x2013;&gt; 1.8.x</a>
<ul>
<li><a href="#orgf6a5071">3.1. Docker 版本支持</a></li>
</ul>
</li>
<li><a href="#org8331777">4. 1.8.x &#x2013;&gt; 1.9.x</a></li>
<li><a href="#org3909798">5. 1.9.x &#x2013;&gt; 1.10.x</a></li>
</ul>
</div>
</div>
<p>
作为从 0.14.x 版本开始追 Kubernetes 的我来说，有时候也不得不感慨，Kubernetes 社区的升级步伐越来越让人赶不上了，版本追的实在有些累了。但是，有些功能特性不升级还不行，某些版本的向下兼容性做的又不太好，导致每次版本变化较大的升级都让人提心吊胆。 
</p>

<p>
本文主要整理 Kubernetes 版本升级要点，从 <code>1.5.x</code> 版本开始，之前的版本升级可以参考官方说明。Google 云在 Kubernetes 升级的时候说明，不要跨大版本升级，安全起见，建议一个版本一个版本升级。
</p>

<blockquote>
<p>
Note: You cannot upgrade your cluster master more than one minor version at a time. For example, you can upgrade a cluster from version 1.6.x to 1.7.x, but not directly from 1.6.x to 1.8.x. For more information, refer to Versioning and Upgrades.  <a href="https://cloud.google.com/kubernetes-engine/docs/how-to/upgrading-a-cluster">Upgrading a Cluster</a>
</p>
</blockquote>

<div id="outline-container-org10309ec" class="outline-2">
<h2 id="org10309ec"><span class="section-number-2">1</span> 1.5.x &#x2013;&gt; 1.6.x</h2>
<div class="outline-text-2" id="text-1">
<p>
之所以从版本 1.5.x 升级到 1.6.x 开始说起，是因为这个大版本更新变动较大，升级注意点较多。因为牵扯一些兼容性的问题，这次升级需要在停服的情况下进行。
</p>

<ul class="org-ul">
<li><a href="https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG-1.6.md#warning-etcd-backup-strongly-recommended">WARNING: etcd backup strongly recommended</a></li>
</ul>
</div>

<div id="outline-container-org3121dd8" class="outline-3">
<h3 id="org3121dd8"><span class="section-number-3">1.1</span> etcd 备份和数据迁移</h3>
<div class="outline-text-3" id="text-1-1">
<p>
从 1.6.0 版本开始，Kubernetes 默认使用 etcd v3，虽然可以通过选项设置继续使用 etcd v2，但是还是建议使用 etcd v3 版本，未来的 Kubernetes 版本也会废弃对 etcd v2 的支持。
</p>

<p>
etcd 的版本升级以及数据版本迁移详见以下两篇文档：
</p>

<ul class="org-ul">
<li><a href="https://github.com/etcd-io/etcd/blob/master/Documentation/upgrades/upgrade_3_0.md#preparation">Upgrade etcd from 2.3 to 3.0</a></li>
<li><a href="https://coreos.com/blog/migrating-applications-etcd-v3.html">Migrating applications, clusters, and Kubernetes to etcd v3</a></li>
</ul>

<p>
a、关闭服务
</p>

<pre class="example">
service etcd stop
</pre>

<p>
b、数据备份
</p>

<pre class="example">
etcdctl backup \
      --data-dir /var/lib/etcd \
      --backup-dir /tmp/etcd_backup
</pre>

<p>
c、数据迁移
</p>

<pre class="example">
ETCDCTL_API=3 etcdctl migrate --data-dir=${data_dir}
</pre>

<p>
d、启动服务
</p>

<pre class="example">
service etcd start
</pre>

<p>
当然，如果你需要继续使用 etcd v2，那么可以针对 <code>apiserver</code> 添加以下配置：
</p>

<pre class="example">
--storage-backend=etcd2 --storage-media-type=application/json
</pre>

<blockquote>
<p>
为什么推荐使用 etcd v3，一个原因是后续版本的兼容问题，另外一个就是性能原因。从 1.6.0 版本，通过 etcd v3，Kubernetes 已支持 5000 个节点。
</p>
</blockquote>
</div>
</div>

<div id="outline-container-orgdfa6822" class="outline-3">
<h3 id="orgdfa6822"><span class="section-number-3">1.2</span> Docker 版本支持</h3>
<div class="outline-text-3" id="text-1-2">
<p>
从 1.6.0 开始，不再支持 Docker 1.9.x，1.10.3、1.11.2、1.12.6 验证通过。
</p>

<p>
另外一个需要用户明白的是，1.6.0 Kubelet 默认启用 Docker-CRI 实现，因此老版本 Kubelet 创建的容器和当前的版本是不支持的，官方建议的做法是在升级前，提前通过 <code>drain</code> 旧版本的节点，否则默认 Kubelet 会自动重启所有的容器。
</p>

<blockquote>
<p>
<a href="https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG-1.6.md#node-components">1.6 node components</a>  Kubelet with the Docker-CRI implementation The Docker-CRI implementation is enabled by default. It is not compatible with containers created by older Kubelets. It is recommended to drain your node before upgrade. If you choose to perform an in-place upgrade, the Kubelet will automatically restart all Kubernetes-managed containers on the node.  It is not compatible with CNI plugins that do not conform to the error handling behavior in the spec. The plugins are being updated to resolve this issue (#43488). You can disable CRI explicitly (&#x2013;enable-cri=false) as a temporary workaround.\\  The standard bridge plugin have been validated to interoperate with the new CRI + CNI code path. If you are using plugins other than bridge, make sure you have updated custom plugins to the latest version that is compatible.
</p>
</blockquote>
</div>
</div>
</div>

<div id="outline-container-org93c2249" class="outline-2">
<h2 id="org93c2249"><span class="section-number-2">2</span> 1.6.x &#x2013;&gt; 1.7.x</h2>
<div class="outline-text-2" id="text-2">
<p>
1.7 版本是针对安全、有状态服务以及可扩展功能里程碑版本，<a href="https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG-1.7.md#major-themes">1.7.0 Major Themes</a>。
</p>

<p>
根据文档 <a href="https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG-1.7.md#action-required-before-upgrading">Action Required Before Upgrading</a> 描述，如果你之前使用过 NetwokPolicy，可以参考 <a href="https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG-1.7.md#network">Network</a> 说明，其它版本选项没有大的变动。
</p>
</div>
</div>

<div id="outline-container-org3ad6037" class="outline-2">
<h2 id="org3ad6037"><span class="section-number-2">3</span> 1.7.x &#x2013;&gt; 1.8.x</h2>
<div class="outline-text-2" id="text-3">
<p>
在升级之前参考 <a href="https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG-1.8.md#before-upgrading">1.8.0 Before Upgrading</a> 官方文档，有以下几个点值得注意： 
</p>

<ul class="org-ul">
<li>默认 1.8.x 在节点启用 swap 的时候 Kubelet 会启动失败，需要额外添加选项 <code>--fail-swap-on=false</code> - ThirdPartyResource（TPR）API 被移除，需迁移至 <a href="https://kubernetes.io/docs/tasks/access-kubernetes-api/migrate-third-party-resource/">CustomResourceDefinition（CRD）</a> - Kubelet 指定 master 节点的选项 <code>api-servers</code> 被废弃，需要通过 <code>--kubeconfig</code> 替换。</li>
</ul>
</div>

<div id="outline-container-orgf6a5071" class="outline-3">
<h3 id="orgf6a5071"><span class="section-number-3">3.1</span> Docker 版本支持</h3>
<div class="outline-text-3" id="text-3-1">
<p>
Docker 1.11.2、1.12.6、1.13.1 以及 17.03.2 验证通过。
</p>
</div>
</div>
</div>

<div id="outline-container-org8331777" class="outline-2">
<h2 id="org8331777"><span class="section-number-2">4</span> 1.8.x &#x2013;&gt; 1.9.x</h2>
<div class="outline-text-2" id="text-4">
<ul class="org-ul">
<li><a href="https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG-1.9.md#before-upgrading">1.9.0 Before Upgrading</a>
<ul class="org-ul">
<li><code>--portal-net</code> 、 <code>--service-node-ports</code> 选项在 <code>apiserver</code> 中被移除</li>
<li><code>--network-plugin-dir</code> 选项在 <code>kubelet</code> 中被移除</li>
</ul></li>
</ul>
</div>
</div>

<div id="outline-container-org3909798" class="outline-2">
<h2 id="org3909798"><span class="section-number-2">5</span> 1.9.x &#x2013;&gt; 1.10.x</h2>
<div class="outline-text-2" id="text-5">
<ul class="org-ul">
<li><a href="https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG-1.10.md#before-upgrading">1.10.0 Before Upgrading</a>
<ul class="org-ul">
<li>In-place node upgrades to this release from versions 1.7.14, 1.8.9, and 1.9.4 are not supported if using subpath volumes with PVCs. Such pods should be drained from the node first.
<ul class="org-ul">
<li>从这句话来看，其实跨大版本升级应该是可以的，不过按部就班升级总归是没有错的</li>
</ul></li>
<li>最小版本的 Docker 支持版本为 1.11，1.10 不再支持</li>
<li><code>kubelet</code> 中 <code>--require-kubeconfig</code> 选项已被废弃</li>
<li><code>apiserver</code> 中 <code>--insecure-bind-address</code> 、 <code>--insecure-port</code> 废弃，并会在未来版本移除，使用 <code>--secure-port</code> 、 <code>--bind-address</code> 替换 - <code>apiserver</code> 中使用 <code>--enable-admission-plugins</code> 、 <code>--disable-admission-plugins</code>  选项替换 <code>--admission-control</code></li>
</ul></li>
</ul>

<p>
以上只是摘取笔者觉得相对重要的点加以说明，并不会覆盖所有的选项。每一次大版本升级还是建议熟读官方说明以及升级前充分做好备份，把风险和影响降到最低。升级有风险，操作需谨慎，敬畏精神不可丢。
</p>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Date: 2018-09-07 Fri 00:00</p>
<p class="author">Author: Kumu</p>
<p class="date">Created: 2019-09-22 Sun 19:59</p>
<p class="validation"></p>
</div>
</body>
</html>
